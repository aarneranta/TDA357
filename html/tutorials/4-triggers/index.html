

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Exercises on triggers &mdash; Databases HT2016</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Databases HT2016" href="../../index.html"/>
        <link rel="up" title="Exercises (a.k.a. Tutorials)" href="../index.html"/>
        <link rel="next" title="XML Tutorial" href="../6-xml/index.html"/>
        <link rel="prev" title="Relational algebra and queries" href="../3-queries/index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Databases
          

          
          </a>

          
            
            
              <div class="version">
                HT2016
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search course" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../slides/index.html">Lectures</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Exercises (a.k.a. Tutorials)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../3-queries/index.html">Relational algebra and queries</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Exercises on triggers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#exercise-1-flight-booking">Exercise 1: Flight booking</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exercise-2-at-the-restaurant">Exercise 2: At the restaurant</a></li>
<li class="toctree-l3"><a class="reference internal" href="#exercise-3-wiki">Exercise 3: Wiki</a></li>
<li class="toctree-l3"><a class="reference internal" href="#solutions">Solutions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#exercise-1">Exercise 1</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exercise-2">Exercise 2</a></li>
<li class="toctree-l4"><a class="reference internal" href="#exercise-3">Exercise 3</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../6-xml/index.html">XML Tutorial</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../lab/index.html">Programming Assignment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../course_book.html">Course Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pgtips/index.html">PostgreSQL Tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xml/index.html">Using XPath and XQuery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../exam/index.html">Exam Information</a></li>
<li class="toctree-l1"><a class="reference external" href="https://se.timeedit.net/web/chalmers/db1/public/ri157XQQ709Z50Qv17043gZ6y6Y7002Q5Y61Y5.html">Schedule</a></li>
<li class="toctree-l1"><a class="reference external" href="https://groups.google.com/forum/#!forum/tda357-vt2016">Course Google Group</a></li>
<li class="toctree-l1"><a class="reference external" href="https://student.portal.chalmers.se/en/chalmersstudies/courseinformation/Pages/SearchCourse.aspx?course_id=21851&amp;parsergrp=3">Student Portal Entry</a></li>
<li class="toctree-l1"><a class="reference external" href="https://databases-vt16.fire.cse.chalmers.se/">Fire submission system</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Databases</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Course</a> &raquo;</li>
      
        <li><a href="../index.html">Exercises (a.k.a. Tutorials)</a> &raquo;</li>
      
    <li>Exercises on triggers</li>
    <li class="wy-breadcrumbs-aside">
      
        
          <a href="https://gitlab.com/gdetrez/dbcourse/blob/master/tutorials/4-triggers/index.rst">Edit on gitlab</a>
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="exercises-on-triggers">
<h1>Exercises on triggers<a class="headerlink" href="#exercises-on-triggers" title="Permalink to this headline">¶</a></h1>
<div class="section" id="exercise-1-flight-booking">
<h2>Exercise 1: Flight booking<a class="headerlink" href="#exercise-1-flight-booking" title="Permalink to this headline">¶</a></h2>
<p>Remember the schema from last week about flights and airports:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Airports(_code_,city)
FlightCodes(_code_, airlineName)
Flights(origin, destination, departure, arrival, _code_)
  origin → Airports.code
  destination → Airports.code
  code → FlightCodes.code
</pre></div>
</div>
<p>Assume the following two tables are added to this schema: a table listing for
each flight the number of available seats and the price per ticket:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>AvailableFlights(_flight_, _date_, numberOfFreeSeats, price)
  flight → Flights.code
</pre></div>
</div>
<p>And another one listing the passengers that have been booked for each flight,
with the price they have paid and a unique booking reference number (an
integer, to keep things simple):</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Bookings(_reference_, flight, date, passenger, price)
  (flight, date) → AvailableFlights.(code, date)
</pre></div>
</div>
<p><strong>Question 1</strong>
Create a view that lists booking references, passengers, flight codes, date,
and departure and destination cities.</p>
<p><strong>Question 2</strong>
Create a trigger on the view defined in quesiton one. This trigger takes care
of booking a new passenger to a flight. It is fired by an insertion of a
passenger and a flight code to the view, for instance, “book Annie Adams for
AF666 on 2016-03-18”. Its effect should be the following:</p>
<ul class="simple">
<li>if the number of free seats on AF666 at this date is positive, decrement it
by one; the booking is successful</li>
<li>if there are no free seats, the booking fails</li>
<li>if the booking is successful, add Annie Adams and AF666 to Bookings at the
given date, with the price given in <code class="docutils literal"><span class="pre">AvailableFlights</span></code> when booking her;
also add a booking reference which is the maximum of the previous references
(for all flights) plus one</li>
<li>if the booking is successful, increment the price by 50 SEK for the next
passenger (thus the fuller the flight, the more you pay)</li>
</ul>
<p><strong>Question 3</strong>
The airline decides to upgrade its database to keep track of its fleet.  This
means adding a table to list the available planes and updating the
<code class="docutils literal"><span class="pre">AvailableFlights</span></code> in the following way:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Planes(_regnr_, capacity)
AvailableFlights(_flight_, _date_, numberOfFreeSeats, price, plane)
  (flight, date) → Flights.(code, date)
  plane → Planes.regnr
</pre></div>
</div>
<p>We now have duplicated information in the database: we can compute the number
of free seats by subtracting the number of booked seats to the capacity of the
plane.  One solution would be to simply remove the <code class="docutils literal"><span class="pre">numberOfFreeSeats</span></code> column
but, as it is often the case with production databases, it is impossible to
update all the systems accessing the database at once to make use of the new
schema, which means that the duplicated field needs to be present in the
database during a transition period.</p>
<p>To make the transition easier, we would like to have the value of the
<code class="docutils literal"><span class="pre">numberOfFreeSeats</span></code> automatically updated.  In particular, if a flight
becomes full well before its departure date, the airline company would like to
be able to change the airplane for a bigger one.  Your job is to create a
trigger that automatically update <code class="docutils literal"><span class="pre">numberOfSeats</span></code> when this happens.</p>
</div>
<div class="section" id="exercise-2-at-the-restaurant">
<h2>Exercise 2: At the restaurant<a class="headerlink" href="#exercise-2-at-the-restaurant" title="Permalink to this headline">¶</a></h2>
<p>In this exercise, we are creating the following database for a restaurant:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>Tables(_number_, seats)
Bookings(_name_, _time_, nbpeople, table)
  table → Tables.number
</pre></div>
</div>
<p>For the sake of simplicity, we assume that the database only needs to hold
bookings for the current day and that bookings are always done on the hour
(i.e. <code class="docutils literal"><span class="pre">time</span></code> is an integer between 0 and 23).</p>
<p>Finally, tables are always booked for two hours.  This means that if table 1
is booked at 19.00, it can&#8217;t be booked at 20.00 but it can be booked again at
21.00.</p>
<p><strong>Question 1</strong>
Write a view that lists the times at which tables are blocked by a booking.  In
the example above, where table 1 is booked at 19.00, the view should contain
the following rows:</p>
<table border="1" class="docutils">
<colgroup>
<col width="56%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">table</th>
<th class="head">time</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>18</td>
</tr>
<tr class="row-odd"><td>1</td>
<td>19</td>
</tr>
<tr class="row-even"><td>1</td>
<td>20</td>
</tr>
</tbody>
</table>
<p><strong>Question 2</strong>
Write a trigger on the table <code class="docutils literal"><span class="pre">Bookings</span></code> that automatically assign a table to
new rows if none is specified.  The assigned table should respect the following
rules:</p>
<ul class="simple">
<li>it should be free for the duration of the booking.</li>
<li>it should be big enough for the number of people in the party</li>
<li>it should be the smallest possible table to accommodate this number of people</li>
</ul>
</div>
<div class="section" id="exercise-3-wiki">
<h2>Exercise 3: Wiki<a class="headerlink" href="#exercise-3-wiki" title="Permalink to this headline">¶</a></h2>
<p>In this exercise, we are creating a database for a wiki.  A wiki is a website
that <em>allows collaborative modification of its content and structure directly
from the web browser</em> (Wikipedia).</p>
<p>To make collaborative edition easier, we needs to keep an history of the
modifications of each page.  To achieve this, we will use a simple model that
simply keeps each version of each page as a separate row:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>PageRevision(_name_, _date_, author, text)
</pre></div>
</div>
<p><strong>Question 1</strong>
To make it easier to access the wiki, creat a view
<code class="docutils literal"><span class="pre">Page(name,</span> <span class="pre">last_author,</span> <span class="pre">text)</span></code> that shows only the latest version of each
page.</p>
<p><strong>Question 2</strong>
Create a trigger on your newly created view so that when a user tries to update
a given page, a new revision is created instead.</p>
<p>Sometimes, pages on the wiki needs to be completely deleted (for instance, if
a page contains sensitive information or copyrighted content).  In that case,
we want to remove all revisions of the page from the database but we still want
to remember that the page has existed but has been deleted.  To this end, we
add the following table to our database:</p>
<div class="highlight-text"><div class="highlight"><pre><span></span>DeleteLog(_pagename_, _date_)
</pre></div>
</div>
<p><strong>Question 3</strong>
Write a trigger on the <code class="docutils literal"><span class="pre">Page</span></code> view such that when a page is deleted:</p>
<ul class="simple">
<li>all its revisions are removed from the database</li>
<li>the deletion is recorded in the <code class="docutils literal"><span class="pre">DeleteLog</span></code>.</li>
</ul>
</div>
<div class="section" id="solutions">
<span id="solution-tutorial4"></span><h2>Solutions<a class="headerlink" href="#solutions" title="Permalink to this headline">¶</a></h2>
<p>Material used during the tutorial: <a class="reference download internal" href="../../_downloads/slides1.pdf" download=""><code class="xref download docutils literal"><span class="pre">slides</span></code></a>,
<a class="reference download internal" href="../../_downloads/handout1.pdf" download=""><code class="xref download docutils literal"><span class="pre">handout</span></code></a>,
<a class="reference download internal" href="../../_downloads/exercise1-setup.sql" download=""><code class="xref download docutils literal"><span class="pre">database</span> <span class="pre">setup</span> <span class="pre">(exercise</span> <span class="pre">1)</span></code></a>,
<a class="reference download internal" href="../../_downloads/exercise2-setup.sql" download=""><code class="xref download docutils literal"><span class="pre">database</span> <span class="pre">setup</span> <span class="pre">(exercise</span> <span class="pre">2)</span></code></a>,
<a class="reference download internal" href="../../_downloads/exercise3-setup.sql" download=""><code class="xref download docutils literal"><span class="pre">database</span> <span class="pre">setup</span> <span class="pre">(exercise</span> <span class="pre">3)</span></code></a>.</p>
<div class="section" id="exercise-1">
<h3>Exercise 1<a class="headerlink" href="#exercise-1" title="Permalink to this headline">¶</a></h3>
<div class="literal-block-wrapper container" id="exercise1-solution-question1">
<div class="code-block-caption"><span class="caption-text">Question 1</span><a class="headerlink" href="#exercise1-solution-question1" title="Permalink to this code">¶</a></div>
<div class="highlight-postgresql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">VIEW</span> <span class="n">Itineraries</span> <span class="k">AS</span>
  <span class="k">SELECT</span>
    <span class="n">reference</span><span class="p">,</span> <span class="n">passenger</span><span class="p">,</span> <span class="n">flight</span><span class="p">,</span> <span class="nb">date</span><span class="p">,</span>
    <span class="n">departure</span><span class="mf">.</span><span class="n">city</span> <span class="k">as</span> <span class="n">departure</span><span class="p">,</span> <span class="n">destination</span><span class="mf">.</span><span class="n">city</span> <span class="k">as</span> <span class="n">destination</span>
  <span class="k">FROM</span>
    <span class="n">Bookings</span>
    <span class="k">JOIN</span> <span class="n">Flights</span> <span class="k">ON</span> <span class="n">Bookings</span><span class="mf">.</span><span class="n">flight</span> <span class="o">=</span> <span class="n">Flights</span><span class="mf">.</span><span class="n">code</span>
    <span class="k">JOIN</span> <span class="n">Airports</span> <span class="k">AS</span> <span class="n">Departure</span> <span class="k">ON</span> <span class="n">departureAirport</span> <span class="o">=</span> <span class="n">Departure</span><span class="mf">.</span><span class="n">code</span>
    <span class="k">JOIN</span> <span class="n">Airports</span> <span class="k">AS</span> <span class="n">Destination</span> <span class="k">ON</span> <span class="n">destinationAirport</span> <span class="o">=</span> <span class="n">Destination</span><span class="mf">.</span><span class="n">code</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="exercise1-solution-question2">
<div class="code-block-caption"><span class="caption-text">Question 2</span><a class="headerlink" href="#exercise1-solution-question2" title="Permalink to this code">¶</a></div>
<div class="highlight-postgresql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">insert_itinerary</span><span class="p">()</span> <span class="k">RETURNS</span> <span class="k">TRIGGER</span> <span class="k">AS</span> <span class="s">$$</span>
<span class="k">DECLARE</span>
  <span class="n">ticket_price</span> <span class="nb">INTEGER</span><span class="p">;</span>
  <span class="n">new_reference</span> <span class="nb">INTEGER</span><span class="p">;</span>
<span class="k">BEGIN</span>
  <span class="c1">-- First, check that there are at least one seat left on the flight</span>
  <span class="k">IF</span> <span class="k">NOT</span> <span class="mf">0</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">numberOfFreeSeats</span> <span class="k">FROM</span> <span class="n">AvailableFlights</span> <span class="k">WHERE</span> <span class="n">flight</span> <span class="o">=</span> <span class="n">NEW</span><span class="mf">.</span><span class="n">flight</span><span class="p">)</span>
    <span class="k">THEN</span> <span class="k">RAISE</span> <span class="k">EXCEPTION</span> <span class="s1">&#39;Flight fully booked&#39;</span><span class="p">;</span>
  <span class="k">END</span> <span class="k">IF</span><span class="p">;</span>

  <span class="n">ticket_price</span> <span class="o">:=</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">price</span> <span class="k">FROM</span> <span class="n">AvailableFlights</span> <span class="k">WHERE</span> <span class="n">flight</span> <span class="o">=</span> <span class="n">NEW</span><span class="mf">.</span><span class="n">flight</span><span class="p">);</span>
  <span class="n">new_reference</span> <span class="o">:=</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="k">COALESCE</span><span class="p">(</span><span class="n">MAX</span><span class="p">(</span><span class="n">reference</span><span class="p">),</span> <span class="mf">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1</span>
    <span class="k">FROM</span> <span class="n">Bookings</span>
    <span class="k">WHERE</span> <span class="n">flight</span> <span class="o">=</span> <span class="n">new</span><span class="mf">.</span><span class="n">flight</span>
  <span class="p">);</span>

  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">Bookings</span><span class="p">(</span><span class="n">reference</span><span class="p">,</span> <span class="n">flight</span><span class="p">,</span> <span class="nb">date</span><span class="p">,</span> <span class="n">passenger</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
    <span class="k">VALUES</span> <span class="p">(</span><span class="n">new_reference</span><span class="p">,</span> <span class="n">NEW</span><span class="mf">.</span><span class="n">flight</span><span class="p">,</span> <span class="n">NEW</span><span class="mf">.</span><span class="nb">date</span><span class="p">,</span> <span class="n">NEW</span><span class="mf">.</span><span class="n">passenger</span><span class="p">,</span> <span class="n">ticket_price</span><span class="p">);</span>

  <span class="k">UPDATE</span> <span class="n">AvailableFlights</span>
  <span class="k">SET</span> <span class="n">price</span> <span class="o">=</span> <span class="n">price</span> <span class="o">+</span> <span class="mf">1</span>
  <span class="k">WHERE</span> <span class="n">flight</span> <span class="o">=</span> <span class="n">new</span><span class="mf">.</span><span class="n">flight</span><span class="p">;</span>

  <span class="k">RETURN</span> <span class="n">NEW</span><span class="p">;</span>
<span class="k">END</span>
<span class="s">$$</span> <span class="k">LANGUAGE</span> <span class="s1">&#39;plpgsql&#39;</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TRIGGER</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">InsertItinerary</span> <span class="k">ON</span> <span class="n">Itineraries</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">InsertItinerary</span> <span class="k">INSTEAD</span> <span class="k">OF</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">Itineraries</span>
  <span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span> <span class="k">EXECUTE</span> <span class="k">PROCEDURE</span> <span class="n">insert_itinerary</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="exercise1-solution-question3">
<div class="code-block-caption"><span class="caption-text">Question 3</span><a class="headerlink" href="#exercise1-solution-question3" title="Permalink to this code">¶</a></div>
<div class="highlight-postgresql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">update_plane</span><span class="p">()</span> <span class="k">RETURNS</span> <span class="k">TRIGGER</span> <span class="k">AS</span> <span class="s">$$</span>
<span class="k">DECLARE</span>
  <span class="n">size_difference</span> <span class="nb">INTEGER</span><span class="p">;</span>
<span class="k">BEGIN</span>
  <span class="n">size_difference</span> <span class="o">:=</span>
    <span class="p">(</span><span class="k">SELECT</span> <span class="n">capacity</span> <span class="k">FROM</span> <span class="n">Planes</span> <span class="k">WHERE</span> <span class="n">regnr</span><span class="o">=</span><span class="n">new</span><span class="mf">.</span><span class="n">plane</span><span class="p">)</span>
    <span class="o">-</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">capacity</span> <span class="k">FROM</span> <span class="n">Planes</span> <span class="k">WHERE</span> <span class="n">regnr</span> <span class="o">=</span> <span class="n">old</span><span class="mf">.</span><span class="n">plane</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="mf">.</span><span class="n">numberOfFreeSeats</span> <span class="o">+</span> <span class="n">size_difference</span> <span class="o">&lt;</span> <span class="mf">0</span><span class="p">)</span> <span class="k">THEN</span>
    <span class="k">RAISE</span> <span class="k">EXCEPTION</span> <span class="s1">&#39;Plane too small!&#39;</span><span class="p">;</span>
  <span class="k">ELSE</span>
    <span class="n">new</span><span class="mf">.</span><span class="n">numberOfFreeSeats</span> <span class="o">:=</span> <span class="n">new</span><span class="mf">.</span><span class="n">numberOfFreeSeats</span> <span class="o">+</span> <span class="n">size_difference</span><span class="p">;</span>
  <span class="k">END</span> <span class="k">IF</span><span class="p">;</span>

  <span class="k">RETURN</span> <span class="n">new</span><span class="p">;</span>
<span class="k">END</span>
<span class="s">$$</span> <span class="k">LANGUAGE</span> <span class="s1">&#39;plpgsql&#39;</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TRIGGER</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">UpdatePlane</span> <span class="k">ON</span> <span class="n">AvailableFlights</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">UpdatePlane</span> <span class="k">BEFORE</span> <span class="k">UPDATE</span> <span class="k">ON</span> <span class="n">AvailableFlights</span>
  <span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span>
  <span class="k">WHEN</span> <span class="p">(</span><span class="n">new</span><span class="mf">.</span><span class="n">plane</span> <span class="o">&lt;&gt;</span> <span class="n">old</span><span class="mf">.</span><span class="n">plane</span><span class="p">)</span>
  <span class="k">EXECUTE</span> <span class="k">PROCEDURE</span> <span class="n">update_plane</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="exercise-2">
<h3>Exercise 2<a class="headerlink" href="#exercise-2" title="Permalink to this headline">¶</a></h3>
<div class="literal-block-wrapper container" id="exercise2-solution-question1">
<div class="code-block-caption"><span class="caption-text">Question 1</span><a class="headerlink" href="#exercise2-solution-question1" title="Permalink to this code">¶</a></div>
<div class="highlight-postgresql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">VIEW</span> <span class="n">BlockedTables</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="n">tablenum</span><span class="p">,</span> <span class="nb">time</span> <span class="o">-</span> <span class="mf">1</span> <span class="k">FROM</span> <span class="n">Bookings</span> <span class="k">WHERE</span> <span class="nb">time</span> <span class="o">&gt;</span> <span class="mf">0</span>
<span class="k">UNION</span>
<span class="k">SELECT</span> <span class="n">tablenum</span><span class="p">,</span> <span class="nb">time</span> <span class="k">FROM</span> <span class="n">Bookings</span>
<span class="k">UNION</span>
<span class="k">SELECT</span> <span class="n">tablenum</span><span class="p">,</span> <span class="nb">time</span> <span class="o">+</span> <span class="mf">1</span> <span class="k">FROM</span> <span class="n">Bookings</span> <span class="k">WHERE</span> <span class="nb">time</span> <span class="o">&lt;</span> <span class="mf">23</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="exercise2-solution-question2">
<div class="code-block-caption"><span class="caption-text">Question 2</span><a class="headerlink" href="#exercise2-solution-question2" title="Permalink to this code">¶</a></div>
<div class="highlight-postgresql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">assign_table</span><span class="p">()</span> <span class="k">RETURNS</span> <span class="k">TRIGGER</span> <span class="k">AS</span> <span class="s">$$</span>
<span class="k">BEGIN</span>

  <span class="n">NEW</span><span class="mf">.</span><span class="n">tablenum</span> <span class="o">:=</span><span class="p">(</span>
    <span class="k">WITH</span> <span class="n">possible_tables</span> <span class="k">AS</span> <span class="p">(</span>
      <span class="k">SELECT</span> <span class="n">number</span><span class="p">,</span> <span class="n">seats</span>
      <span class="k">FROM</span> <span class="k">tables</span>
      <span class="k">WHERE</span> <span class="p">(</span><span class="n">number</span><span class="p">,</span> <span class="n">new</span><span class="mf">.</span><span class="nb">time</span><span class="p">)</span> <span class="k">NOT</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">BlockedTables</span><span class="p">)</span>
        <span class="k">AND</span> <span class="n">seats</span> <span class="o">&gt;=</span> <span class="n">new</span><span class="mf">.</span><span class="n">nbpeople</span>
    <span class="p">)</span>
    <span class="k">SELECT</span> <span class="n">MIN</span><span class="p">(</span><span class="n">number</span><span class="p">)</span>
    <span class="k">FROM</span> <span class="n">possible_tables</span>
    <span class="k">WHERE</span> <span class="n">seats</span> <span class="o">=</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">MIN</span><span class="p">(</span><span class="n">seats</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">possible_tables</span><span class="p">));</span>

    <span class="k">IF</span> <span class="p">(</span><span class="n">NEW</span><span class="mf">.</span><span class="n">tablenum</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">)</span> <span class="k">THEN</span>
      <span class="k">RAISE</span> <span class="k">EXCEPTION</span> <span class="s1">&#39;No table available&#39;</span><span class="p">;</span>
    <span class="k">END</span> <span class="k">IF</span><span class="p">;</span>

  <span class="k">RETURN</span> <span class="n">NEW</span><span class="p">;</span>
<span class="k">END</span>
<span class="s">$$</span> <span class="k">LANGUAGE</span> <span class="s1">&#39;plpgsql&#39;</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TRIGGER</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">AssignTable</span> <span class="k">ON</span> <span class="n">Bookings</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">AssignTable</span> <span class="k">BEFORE</span> <span class="k">INSERT</span> <span class="k">ON</span> <span class="n">Bookings</span>
  <span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span>
  <span class="k">WHEN</span> <span class="p">(</span><span class="n">NEW</span><span class="mf">.</span><span class="n">tablenum</span> <span class="k">IS</span> <span class="k">NULL</span><span class="p">)</span>
  <span class="k">EXECUTE</span> <span class="k">PROCEDURE</span> <span class="n">assign_table</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="exercise-3">
<h3>Exercise 3<a class="headerlink" href="#exercise-3" title="Permalink to this headline">¶</a></h3>
<div class="literal-block-wrapper container" id="exercise3-solution-question1">
<div class="code-block-caption"><span class="caption-text">Question 1</span><a class="headerlink" href="#exercise3-solution-question1" title="Permalink to this code">¶</a></div>
<div class="highlight-postgresql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">VIEW</span> <span class="n">Pages</span> <span class="k">AS</span>
<span class="k">SELECT</span> <span class="k">name</span><span class="p">,</span> <span class="n">PR1</span><span class="mf">.</span><span class="n">author</span> <span class="k">AS</span> <span class="n">last_author</span><span class="p">,</span> <span class="n">PR1</span><span class="mf">.</span><span class="nb">text</span>
<span class="k">FROM</span>  <span class="n">PageRevisions</span> <span class="k">AS</span> <span class="n">PR1</span> <span class="k">JOIN</span> <span class="n">PageRevisions</span> <span class="k">AS</span> <span class="n">PR2</span> <span class="k">USING</span> <span class="p">(</span><span class="k">name</span><span class="p">)</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">name</span><span class="p">,</span> <span class="n">PR1</span><span class="mf">.</span><span class="nb">date</span>
<span class="k">HAVING</span> <span class="n">pr1</span><span class="mf">.</span><span class="nb">date</span> <span class="o">=</span> <span class="n">MAX</span><span class="p">(</span><span class="n">pr2</span><span class="mf">.</span><span class="nb">date</span><span class="p">)</span> <span class="p">;</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="exercise3-solution-question2">
<div class="code-block-caption"><span class="caption-text">Question 2</span><a class="headerlink" href="#exercise3-solution-question2" title="Permalink to this code">¶</a></div>
<div class="highlight-postgresql"><div class="highlight"><pre><span></span><span class="c1">-- ~~~ Question 2 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">insert_revision</span><span class="p">()</span> <span class="k">RETURNS</span> <span class="k">TRIGGER</span> <span class="k">AS</span> <span class="s">$$</span>
<span class="k">BEGIN</span>
  <span class="k">Insert</span> <span class="k">into</span> <span class="n">pageRevisions</span><span class="p">(</span><span class="k">name</span><span class="p">,</span> <span class="nb">date</span><span class="p">,</span> <span class="n">author</span><span class="p">,</span> <span class="nb">text</span><span class="p">)</span>
  <span class="k">values</span> <span class="p">(</span><span class="n">new</span><span class="mf">.</span><span class="k">name</span><span class="p">,</span> <span class="n">now</span><span class="p">(),</span> <span class="n">new</span><span class="mf">.</span><span class="n">last_author</span><span class="p">,</span> <span class="n">NEW</span><span class="mf">.</span><span class="nb">text</span><span class="p">);</span>

  <span class="k">RETURN</span> <span class="n">NEW</span><span class="p">;</span>
<span class="k">END</span>
<span class="s">$$</span> <span class="k">LANGUAGE</span> <span class="s1">&#39;plpgsql&#39;</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TRIGGER</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">EditPage</span> <span class="k">ON</span> <span class="n">Pages</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">EditPage</span> <span class="k">INSTEAD</span> <span class="k">OF</span> <span class="k">INSERT</span> <span class="k">OR</span> <span class="k">UPDATE</span> <span class="k">ON</span> <span class="n">Pages</span>
<span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span>
<span class="k">EXECUTE</span> <span class="k">PROCEDURE</span> <span class="n">insert_revision</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper container" id="exercise3-solution-question3">
<div class="code-block-caption"><span class="caption-text">Question 3</span><a class="headerlink" href="#exercise3-solution-question3" title="Permalink to this code">¶</a></div>
<div class="highlight-postgresql"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">delete_page</span><span class="p">()</span> <span class="k">RETURNS</span> <span class="k">TRIGGER</span> <span class="k">AS</span> <span class="s">$$</span>
<span class="k">BEGIN</span>
  <span class="k">DELETE</span> <span class="k">FROM</span> <span class="n">PageRevisions</span> <span class="k">WHERE</span> <span class="k">name</span> <span class="o">=</span> <span class="n">OLD</span><span class="mf">.</span><span class="k">name</span><span class="p">;</span>
  <span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">deletelog</span> <span class="k">VALUES</span> <span class="p">(</span><span class="n">old</span><span class="mf">.</span><span class="k">name</span><span class="p">,</span> <span class="n">NOW</span><span class="p">());</span>

  <span class="k">RETURN</span> <span class="n">OLD</span><span class="p">;</span>
<span class="k">END</span>
<span class="s">$$</span> <span class="k">LANGUAGE</span> <span class="s1">&#39;plpgsql&#39;</span><span class="p">;</span>

<span class="k">DROP</span> <span class="k">TRIGGER</span> <span class="k">IF</span> <span class="k">EXISTS</span> <span class="n">DeletePage</span> <span class="k">ON</span> <span class="n">Pages</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">DeletePage</span> <span class="k">INSTEAD</span> <span class="k">OF</span> <span class="k">DELETE</span> <span class="k">ON</span> <span class="n">Pages</span>
<span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span>
<span class="k">EXECUTE</span> <span class="k">PROCEDURE</span> <span class="n">delete_page</span><span class="p">();</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../6-xml/index.html" class="btn btn-neutral float-right" title="XML Tutorial" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../3-queries/index.html" class="btn btn-neutral" title="Relational algebra and queries" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright .

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'HT2016',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>